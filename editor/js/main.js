(function(a){var d={key:"",layout_name:null,status:null,column_count:24,column_width:30,gutter_width:10,totalColWidth:40},j=function(){var c=this;this.Menubar.init();this.Toolbar.init();this.Container.init();this.Editor.init();a(document).keydown(function(b){if(b.keyCode==a.ui.keyCode.ESCAPE&&(b=c.Container.currentSection,b[0]!=c.Container.ui[0]))b.remove(),c.Container.currentSection=c.Container.ui,c.Container.addLast()})},e=j.prototype;j.prototype.Layout={setPageTitle:function(c){var b="Untitled";
typeof c!=="undefined"&&a.trim(c)!=""&&(b=c);document.title=b+" - Layoutside"}};j.prototype.Container={editMode:"",ui:a("#container"),grid:a("#containerGrid"),currentSection:null,isResizingSection:!1,sections:[],init:function(){var a=this;this.setEditMode("select");this.currentSection=this.ui;this.ui.add(this.grid).click(function(){a.setCurrentSection(a.ui);a.setMeasures()})},sortableOptions:{items:"> div[class^=span]",scroll:!1,opacity:0.6,cursor:"move",grid:[d.totalColWidth,10],start:function(a,
b){var d=b.helper.height();b.placeholder.css("height",d+"px !important")},stop:function(){e.Container.addLast()},change:function(){e.Container.addLast()},sort:function(a,b){var d=a.pageY;b.placeholder.parent()[0]!=e.Container.ui[0]&&(d=a.pageY-b.placeholder.parent().position().top);b.helper.css({top:d+"px"})}},setEditMode:function(c){if(this.editMode==c)return null;this.editMode=c;var b=this.ui.hasClass("ui-sortable");e.Toolbar.ui.find("a.icon-select, a.icon-sort").removeClass("icon-active");switch(c){case "sort":a("a.icon-sort").addClass("icon-active");
b?(this.ui.sortable("enable"),this.sections.sortable("enable")):(this.ui.sortable(this.sortableOptions).disableSelection(),this.sortableOptions.containment="parent",this.sections=this.ui.find("div.section").sortable(this.sortableOptions).disableSelection());break;default:b&&(this.ui.sortable("disable"),this.sections.sortable("disable")),a("a.icon-select").addClass("icon-active")}},setCurrentSection:function(c){c=a(c);this.ui.find(".current-section").removeClass("current-section");c.hasClass("section")&&
c.addClass("current-section");this.currentSection=c},getSectionWidth:function(a){return parseInt(a[0].className.split(" ")[0].split("-")[1],10)},addLast:function(c){var b=typeof c!=="undefined",h=a("> .section:not(.ui-sortable-helper)",b?c:this.ui),f=0,e=d.column_count;b&&(e=this.getSectionWidth(c));h.filter(".last").removeClass("last");h.filter(".clear").removeClass("clear");h.css("marginRight",d.gutter_width);for(c=0,b=h.length;c<b;c+=1){var g=a(h[c]),k=this.getSectionWidth(g),m=null;c<b&&(m=a(h[c+
1]));f+=k;f>e?(g.toggleClass("clear"),f=k):f==e&&(g.toggleClass("last"),g.css("marginRight",0),m.length&&m.toggleClass("clear"),f=0);g.find(".section").length&&this.addLast(g)}},setMeasures:function(a,b){var d=e.Container,a=a?a:d.ui.width(),b=b?b:d.ui.height();e.Toolbar.widthInput.val(a);e.Toolbar.heightInput.val(b)},currentSectionId:1,addSection:function(c){var b,h="section-"+this.currentSectionId,f="",i=3;this.currentSectionId+=1;if(typeof c!=="undefined")h=c.html_id,f=c.body,i=c.width,this.currentSectionId+=
1;b=a('<div id="'+h+'" class="span-'+i+' section"><div class="section-content"></div></div>');f!="&nbsp;"&&b.find(".section-content").html(f);var g=this,k=0,m=1;b.click(function(a){a.stopPropagation();k+=1;k<2?(g.setCurrentSection(b.get(0)),g.setMeasures(b.width(),b.height()),window.setTimeout(function(){k=0},500)):k=0});b.mouseover(function(a){if(g.isResizingSection)return!1;a.stopPropagation();b.addClass("hover-section")}).mouseout(function(){b.removeClass("hover-section")});b.resizable({maxWidth:950,
autoHide:!0,zIndex:100,grid:[d.totalColWidth],handles:"e",start:function(){},stop:function(){},resize:function(c,f){var h=f.helper,k=h.width(),i="",j=Math.round(k/d.totalColWidth);e.Toolbar.heightInput.val(f.size.height);if(m==j)return!1;i=h.find("> .section");if(i.length){g.getSectionWidth(h);var n=0;i.each(function(b,c){var d=a(c),f=g.getSectionWidth(d);l("max child w: "+k);d.resizable("option","maxWidth",k);f>n&&(n=f)});b.resizable("option","minWidth",n*d.totalColWidth)}m=j;i=h[0].className;h[0].className=
i.replace(/^span-\d+/,"span-"+j);g.addLast();e.Toolbar.widthInput.val(k)}});if(c&&c.child_of!==null){if(!a("#"+c.child_of).length)throw Error("Failed to add child section");a("#"+c.child_of).append(b)}else this.currentSection.append(b);c=b.parent();c[0]!=g.ui[0]&&b.resizable("option","maxWidth",g.getSectionWidth(c)*d.totalColWidth);this.addLast();e.Menubar.resizeSections()}};j.prototype.Toolbar={ui:a("#toolbar"),widthInput:a("#section-w").val(0),heightInput:a("#section-h").val(0),viewMode:0,init:function(){var c=
e.Container,b=this;a("a.icon").click(function(a){a.preventDefault()});a("a.icon-select").bind("click",function(){c.setEditMode("select")});a("a.icon-sort").bind("click",function(){c.setEditMode("sort")});a("a.icon-section").bind("click",function(){c.addSection()});a("a.icon-toggle-grid").click(function(){switch(b.viewMode){case 0:a(".section").addClass("toggle-section");break;case 1:a("#containerGrid").addClass("toggle-grid");break;case 2:a(".section").removeClass("toggle-section"),a("#containerGrid").removeClass("toggle-grid")}b.viewMode=
(b.viewMode+1)%3});this.heightInput.keyup(function(){var a=b.heightInput.val(),c=e.Container.currentSection;if(!isNaN(a)&&!c.hasClass("container")){a=parseInt(a,10);if(a<24)return!1;c.height(a)}})}};j.prototype.Menubar={loadingLayout:!1,newLayoutDialog:null,layoutPropDialog:null,confirmCloseDialog:null,saveOnCreate:!1,init:function(){function c(b){b=a(b).find("form");a("input[name=layout_name]",b).val(d.layout_name);a("input[name=column_count]",b).val(d.column_count);a("input[name=column_width]",
b).val(d.column_width);a("input[name=gutter_width]",b).val(d.gutter_width)}var b=this;this.buildGrid();a("#menu a:not(.download)").bind("click",function(a){a.preventDefault()});a("#menu a.download").bind("click",function(b){if(!d.key)return b.preventDefault(),alert("Create or edit a layout to download"),!1;b="./download-layout?";switch(a(this).attr("rel")){case "#get-html":b+="html-only=1&key="+d.key;break;case "#get-zip":b+="key="+d.key}a(this).attr("href",b)});a("#new-layout").click(function(){if(!b.closeLayout())return!1;
b.newLayoutDialog.dialog("open")});a("#save-layout").click(function(){b.saveLayout()});a("#open-layout").click(function(){a("#my-layouts").dialog("open")});a("#layout-properties").click(function(){b.layoutPropDialog.dialog("open")});var h=function(){d.key="";d.status=1;d.layout_name=a("#layout-name").val().trim();e.Layout.setPageTitle(d.layout_name);b.newLayoutDialog.dialog("close");a(this).find("form")[0].reset();if(e.Menubar.saveOnCreate)e.Menubar.saveLayout(),e.Menubar.saveOnCreate=!1};this.newLayoutDialog=
a("#new-layout-dialog").dialog({resizable:!1,autoOpen:!1,width:300,modal:!0,buttons:{Create:h,Cancel:function(){b.newLayoutDialog.dialog("close");a(this).find("form")[0].reset()}}}).find("form").submit(function(b){b.preventDefault();h.call(a(this).parent()[0])}).end();this.confirmCloseDialog=a("#confirm-close-dialog").dialog({resizable:!1,autoOpen:!1,width:300,modal:!0,buttons:{"Close without saving":function(){b.closeLayout(!0);b.confirmCloseDialog.dialog("close")},Cancel:function(){b.confirmCloseDialog.dialog("close")}}});
a("#my-layouts").dialog({resizable:!1,autoOpen:!1,width:300,height:175,modal:!0,buttons:{Cancel:function(){a("#my-layouts").dialog("close")}},open:function(){a.getJSON("/editor/layouts",{},function(b,c){if(c!="success")throw Error("Failed to load your layouts");$list=a("#my-layouts table tbody").empty();a(b).each(function(a,b){$list.append("<tr><td>"+b.name+'</td><td style="text-align: right; width: 125px;"><a class="open" lkey="'+b.key+'" href="#'+b.key+'">edit</a> <a target="_blank" href="/editor/render-layout?key='+
b.key+'">preview</a> <a class="delete" href="#'+b.key+'">delete</a></td></tr>')});a("#my-layouts table a.open").click(function(a){a.preventDefault();e.Menubar.open(this.getAttribute("lkey"))});a("#my-layouts table a.delete").click(function(b){b.preventDefault();var c=this;window.confirm("Do you really want to delete the selected layout?")&&a.post("/editor/delete-layout",{key:a(this).attr("href").substr(1)},function(b){b.status==0&&a(c).parents("tr").fadeOut()},"json")})})}});b.layoutPropDialog=a("#layout-prop");
b.layoutPropDialog.dialog({resizable:!1,autoOpen:!1,width:280,height:200,buttons:{Update:function(){var c=a(this).find("form");d.layout_name=a("input[name=layout_name]",c).val();d.column_count=parseInt(a("input[name=column_count]",c).val());d.column_width=parseInt(a("input[name=column_width]",c).val());d.gutter_width=parseInt(a("input[name=gutter_width]",c).val());d.totalColWidth=d.column_width+d.gutter_width;c=d.column_count*(d.column_width+d.gutter_width)-d.gutter_width;a("#layout_width").html(c+
"px");b.buildGrid();b.resizeSections()},Reset:function(){c(this)},Cancel:function(){b.layoutPropDialog.dialog("close");a(this).find("form")[0].reset()}},open:function(){c(this);var b=d.column_count*(d.column_width+d.gutter_width)-d.gutter_width;a("#layout_width").html(b+"px")}})},previewLink:function(c){var b=a("#preview-layout").attr("href");a("#preview-layout").attr("href",b.replace(/key=.+/,"key="+c))},open:function(c){if(this.loadingLayout||!this.closeLayout())return!1;var b=this;l("open layout: "+
c);this.loadingLayout=!0;a.getJSON("/editor/open-layout",{key:c},function(c){e.Toolbar.viewMode=0;a("#containerGrid").removeClass("toggle-grid");d=c.config;e.Layout.setPageTitle(d.layout_name);b.buildGrid();d.status=2;e.Container.currentSection=e.Container.ui;e.Container.currentSectionId=1;for(var f=0,i=c.sections.length;f<i;f++)e.Container.addSection(c.sections[f]);e.Menubar.loadingLayout=!1;a("#my-layouts").dialog("close");e.Container.setEditMode("select");a(window).scrollTop(0);b.resizeSections();
e.Container.setMeasures()})},closeLayout:function(a){if(d.status&4&&typeof a=="undefined")return this.confirmCloseDialog.dialog("open"),!1;e.Layout.setPageTitle();e.Container.ui.empty();e.Container.currentSectionId=1;d.status=1;return!0},buildGrid:function(){for(var c=a("#containerGrid").empty(),b=0,h={};b<d.column_count;b++)h=a(document.createElement("div")),h.css({width:d.column_width,marginRight:d.gutter_width}),c.append(h);b=d.column_count*d.totalColWidth-d.gutter_width;d.layout_width=b;a("#containerPlaceholder").width(b);
l(b);c.find("div:last").css("marginRight",0)},resizeSections:function(){larg=d.column_width;gutter=d.gutter_width;a("div[class^=span-]").each(function(){var b=parseInt(this.className.match(/span-(\d+)/)[1],10),c=b*(larg+gutter),d=gutter;b>1&&(c-=gutter);a(this).hasClass("last")&&(d=0);a(this).css({width:c+"px",marginRight:d+"px"})});var c=d.column_count*(larg+gutter)-gutter;a(".section").resizable("option","grid",[larg+gutter]).resizable("option","maxWidth",c)},saveLayout:function(){function c(d){a("> .section",
d).each(function(f,i){var g=a(i),k=g.children(".section"),g={name:"section name "+f,tagname:i.tagName,body:g.find(".section-content").html()||"&nbsp;",html_id:i.id,css_class:i.className,width:e.Container.getSectionWidth(g),child_of:typeof d=="object"?d.id:null,order:f+1};b.sections.push(g);k.length&&c(i)})}var b={config:d,sections:[]};if(d.layout_name==null||a.trim(d.layout_name)=="")return e.Menubar.newLayoutDialog.dialog("open"),this.saveOnCreate=!0,!1;c("#container");a.ajax({type:"POST",url:"/editor/save-layout",
contentType:"application/json",dataType:"json",data:JSON.stringify(b),error:function(a,b){console.log("XhrError: "+b)},success:function(a){a.status==0?(d.status&1&&alert("New layout saved!"),d.status&2&&alert("Layout updated!"),d.status=2,d.key=a.key):alert("Failed to save layout")}})}};j.prototype.Dialogs={sectionUi:a(".sectionDialog"),initSection:function(){var c=this.sectionUi.clone();c.dialog({resizable:!1,autoOpen:!1,width:300,height:225,modal:!0,open:function(){l("section dialog open")}});a(".space-slider",
c).slider({min:1,max:d.column_count,start:function(){}});return c}};j.prototype.Editor={editor:null,dialogUi:null,init:function(){this.setupDialog();a("#openEditor").click(function(c){a("#editor").dialog("open");c.preventDefault()})},startEditor:function(){if(this.editor===null)this.editor=a("#sourceEditor")},setupDialog:function(){var c=null,b=this;this.dialogUi=a("#editor");this.dialogUi.dialog({resizable:!1,autoOpen:!1,minWidth:735,width:735,minHeight:370,height:370,buttons:{Update:function(){if(c==
null)return alert("Select a section"),!1;var a=b.editor.val();c.find("> .section-content").html(a)},Close:function(){b.dialogUi.dialog("close")}},open:function(){function d(e,i){var g=e.find("> .section");if(!g.length)return!1;i||(i=document.createElement("ul"),a("#sectionview").append(i));g.each(function(e,g){var f=a(document.createElement("li")),j=a(g);f.html('<a href="#">Section '+(e+1)+"</a>");f.find("a").data("sectionRef",g).click(function(d){c=a(a(this).data("sectionRef"));var e=c.find(".section-content");
d.preventDefault();a("#sectionview li a").removeClass("selected-section");f.children("a").addClass("selected-section");b.editor.val(e.html())});a(i).append(f);if(j.find("> .section").length){var l=document.createElement("ul");f.append(l);d(j,l)}})}b.startEditor();a("#sectionview").empty();d(e.Container.ui,null);b.editor.html(c.find(".section-content").html())}})}};window.Layoutside=j;var l=function(a){if(!console)return!1;console.log(a)}})(jQuery);